<!DOCTYPE html>
<html class="h-100" lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Pizza42 • Auth0 SPA Demo - JCR</title>

    <!-- Bootstrap + Auth0 demo theme -->
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/>
    <link rel="stylesheet"
          href="https://cdn.auth0.com/js/auth0-samples-theme/1.0/css/auth0-theme.min.css"/>

    <style>
      :root { --brand:#6c5ce7; }
      body { min-height:100vh; display:flex; flex-direction:column; }
      .navbar-brand img { height:28px; width:28px; border-radius:6px; margin-right:8px; }

      .hero {
        background:
          radial-gradient(900px 300px at 0% -10%, rgba(108,92,231,.16), transparent 60%),
          linear-gradient(135deg, rgba(0,209,178,.10), transparent 60%);
        border-bottom:1px solid rgba(0,0,0,.05);
      }

      .json-box { background:#0b1020; color:#e2e8f0; padding:12px; border-radius:8px; overflow:auto; }
      .status-box { border:1px solid #e5e7eb; background:#f8fafc; padding:10px; border-radius:6px; }
      .status-warn { color:#a15c00; }
      .status-ok { color:#087443; }
      .status-err { color:#8b0000; }
      .hidden { display:none !important; }

      /* Catálogo */
      .card-product { border:none; box-shadow:0 8px 24px rgba(0,0,0,.06); border-radius:14px; }
      .card-product img { border-top-left-radius:14px; border-top-right-radius:14px; object-fit:cover; height:170px; width:100%; }
      .price { font-weight:700; }

      /* Carrito fijo en desktop */
      @media (min-width: 992px) { .cart-sticky { position:sticky; top:24px; } }

      .badge-scope { font-size:.75rem; }
      .small-muted { font-size:.875rem; color:#6b7280; }
    </style>
  </head>

  <body class="h-100">
    <div id="app" class="h-100 d-flex flex-column">

      <!-- NAVBAR -->
      <div class="nav-container">
        <nav class="navbar navbar-expand-md navbar-light bg-light">
          <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="logo.jpg" alt="Pizza42 logo"/>
              <span>Pizza42</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
              <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav mr-auto">
                <li class="nav-item active"><a href="#" class="nav-link">Home</a></li>
              </ul>
              <ul class="navbar-nav">
                <li class="nav-item d-flex align-items-center mr-2">
                  <span id="userDisplay" class="nav-link text-muted small">Not Logged In</span>
                </li>
                <li class="nav-item auth-invisible">
                  <button id="btnLogin" class="btn btn-primary btn-margin">Log in</button>
                </li>
                <li class="nav-item auth-visible hidden">
                  <button id="btnLogout" class="btn btn-outline-secondary btn-margin">Log out</button>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </div>

      <!-- HERO -->
      <header class="hero py-5">
        <div class="container text-center">
          <img src="logo.jpg" alt="Pizza42 logo" style="max-height:96px; opacity:.95;" class="mb-3"/>
          <h1 class="mb-2">Pizza42 — Auth0 SPA Demo</h1>
          <p class="lead mb-1">
            Secure login, verified email, Orders API, and an order snapshot in the ID Token.
          </p>
        </div>
      </header>

      <!-- MAIN -->
      <main class="py-4">
        <div class="container">

          <!-- Status / API actions-->
          <div class="mb-3 d-flex flex-wrap justify-content-between align-items-center">
            <div id="status" class="status-box m-0">Ready. Click <b>Log in</b> to start.</div>
            <div class="mt-2 mt-sm-0">
              <button id="btnList" class="btn btn-sm btn-outline-primary">Order History</button>
            </div>
          </div>

          <div class="row">
            <!-- Catalog -->
            <div class="col-lg-8">
              <h4 class="mb-3">Menu</h4>
              <p class="small-muted mb-3">Add some pizzas to your cart and place your order (protected by Auth0).</p>

              <div class="row" id="catalog"><!-- JS injects cards --></div>

              <ul class="nav nav-tabs mt-4" role="tablist">
                <li class="nav-item">
                  <a class="nav-link active" data-toggle="tab" href="#tabSession" role="tab">Session & ID Token</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-toggle="tab" href="#tabApi" role="tab">API Responses</a>
                </li>
              </ul>
              <div class="tab-content">
                <div id="tabSession" class="tab-pane fade show active p-3">
                  <pre id="sessionBox" class="json-box">{ }</pre>
                  <small id="verifyNote" class="text-warning hidden">
                    <b>Verify email needed</b> — please verify your email to use the Orders API.
                  </small>
                </div>
                <div id="tabApi" class="tab-pane fade p-3">
                  <pre id="apiBox" class="json-box">{ }</pre>
                  <ul id="ordersList" class="list-group mt-3"></ul>
                </div>
              </div>
            </div>

            <!-- Cart -->
            <div class="col-lg-4">
              <div class="card cart-sticky">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <h5 class="m-0">Your Order</h5>
                    <span class="ml-2 badge badge-pill badge-secondary" id="cartCount">0</span>
                  </div>
                  <ul class="list-group mb-3" id="cartList"></ul>
                  <div class="d-flex justify-content-between align-items-center">
                    <strong>Total</strong>
                    <span id="cartTotal" class="price">$0.00</span>
                  </div>
                  <hr/>
                  <button id="btnPlaceOrder" class="btn btn-primary btn-block">Place Order</button>
                  <div id="cartMsg" class="alert d-none mt-2 py-2 px-3" role="alert"></div>
                  <small class="text-muted d-block mt-2">
                    Requires login + verified email.
                  </small>
                </div>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>

    <script>
      // ==== Config ====
      let AUTH0_DOMAIN, AUTH0_CLIENT_ID, API_AUDIENCE, API_BASE;
      let auth0Client;

      async function loadConfig() {
        const res = await fetch("auth_config.json", { cache: "no-cache" });
        if (!res.ok) throw new Error("Could not load auth_config.json");
        const cfg = await res.json();
        AUTH0_DOMAIN    = cfg.domain;
        AUTH0_CLIENT_ID = cfg.clientId;
        API_AUDIENCE    = cfg.audience;
        API_BASE        = cfg.apiBase;
      }

      // ==== Helpers ====
      const $id = (id) => document.getElementById(id);
      function setStatus(type, msg) {
        const el = $id("status");
        el.className = "status-box";
        if (type==="ok") el.classList.add("status-ok");
        if (type==="warn") el.classList.add("status-warn");
        if (type==="err") el.classList.add("status-err");
        el.innerHTML = msg;
      }
      function showJson(id, obj) { $id(id).textContent = JSON.stringify(obj, null, 2); }
      function toggleAuthUi(isAuth) {
        document.querySelectorAll(".auth-visible").forEach(n => n.classList.toggle("hidden", !isAuth));
        document.querySelectorAll(".auth-invisible").forEach(n => n.classList.toggle("hidden", isAuth));
      }

      // ==== Pizza Catalog ====
      const CATALOG = [
        { id:"pepperoni",  name:"Pepperoni",  desc:"Pepperoni, mozzarella, marinara", price: 12.50, img:"pepperoni.jpg" },
        { id:"margherita", name:"Margherita", desc:"Tomato, mozzarella, basil",        price: 11.00, img:"margherita.jpg" },
        { id:"hawaiian",   name:"Hawaiian",   desc:"Ham, pineapple, mozzarella",       price: 13.00, img:"hawaiian.jpg" },
        { id:"veggie",     name:"Veggie",     desc:"Peppers, mushrooms, olives",       price: 12.00, img:"veggie.jpg" }
      ];

      function renderCatalog(){
        const wrap = $id("catalog");
        wrap.innerHTML = "";
        CATALOG.forEach(p => {
          const col = document.createElement("div");
          col.className = "col-sm-6 col-xl-4 mb-4";
          col.innerHTML = `
            <div class="card card-product h-100">
              <img src="${p.img}" alt="${p.name}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-1">${p.name}</h5>
                <p class="text-muted small mb-2">${p.desc}</p>
                <div class="d-flex align-items-center mb-3">
                  <span class="price mr-2">$${p.price.toFixed(2)}</span>
                </div>
                <button class="btn btn-outline-primary mt-auto" data-add="${p.id}">
                  Add to Cart
                </button>
              </div>
            </div>`;
          wrap.appendChild(col);
        });

        // Wire "Add to Cart"
        wrap.querySelectorAll("[data-add]").forEach(btn=>{
          btn.addEventListener("click", () => addToCart(btn.getAttribute("data-add")));
        });
      }

      // ==== Cart (front) ====
      let CART = []; // {id, name, price, qty}

      function addToCart(productId){
        const p = CATALOG.find(x=>x.id===productId);
        if (!p) return;
        const idx = CART.findIndex(i=>i.id===p.id);
        if (idx>=0) CART[idx].qty += 1;
        else CART.push({ id:p.id, name:p.name, price:p.price, qty:1 });
        renderCart();
        setStatus("ok", `Added <b>${p.name}</b> to cart.`);
      }
      function removeFromCart(productId){
        CART = CART.filter(i=>i.id!==productId);
        renderCart();
      }
      function changeQty(productId, delta){
        const item = CART.find(i=>i.id===productId);
        if (!item) return;
        item.qty = Math.max(1, item.qty + delta);
        renderCart();
      }
      function cartTotal(){
        return CART.reduce((sum,i)=> sum + i.price*i.qty, 0);
      }
      function renderCart(){
        const ul = $id("cartList");
        ul.innerHTML = "";
        if (CART.length===0){
          ul.innerHTML = `<li class="list-group-item text-muted">Your cart is empty.</li>`;
        } else {
          CART.forEach(i=>{
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
              <div>
                <strong>${i.name}</strong>
                <div class="small text-muted">$${i.price.toFixed(2)} x ${i.qty}</div>
              </div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" data-qty="-1" data-id="${i.id}">−</button>
                <button class="btn btn-outline-secondary disabled">${i.qty}</button>
                <button class="btn btn-outline-secondary" data-qty="+1" data-id="${i.id}">+</button>
                <button class="btn btn-outline-danger" data-remove="${i.id}">&times;</button>
              </div>`;
            ul.appendChild(li);
          });
        }
        $id("cartTotal").textContent = `$${cartTotal().toFixed(2)}`;
        $id("cartCount").textContent = String(CART.reduce((n,i)=>n+i.qty,0));

        ul.querySelectorAll("[data-remove]").forEach(b=> b.onclick = ()=> removeFromCart(b.getAttribute("data-remove")));
        ul.querySelectorAll("[data-qty]").forEach(b=> b.onclick = ()=> changeQty(b.getAttribute("data-id"), b.getAttribute("data-qty")==="+1" ? 1 : -1));
      }

      // ==== Auth state ====
      async function getAuthState() {
        const isAuth = await auth0Client.isAuthenticated();
        if (!isAuth) return { isAuth:false, user:null, claims:null, emailVerified:false };

        const [user, claims] = await Promise.all([
          auth0Client.getUser(),
          auth0Client.getIdTokenClaims()
        ]);
        const emailVerified = claims?.email_verified ?? user?.email_verified ?? false;
        return { isAuth, user, claims, emailVerified };
      }

      function requireSessionAndEmail(run) {
        return (async () => {
          const { isAuth, emailVerified } = await getAuthState();
          if (!isAuth) return setStatus("err","Requires login. Please click <b>Log in</b> first.");
          if (!emailVerified) return setStatus("err","Verify email needed. Please verify first.");
          return run();
        })();
      }

      async function renderSession() {
        const { isAuth, user, claims, emailVerified } = await getAuthState();
        toggleAuthUi(isAuth);

        if (!isAuth) {
          setStatus("warn", "Not logged in. Click <b>Log in</b> to start.");
          showJson("sessionBox", {});
          $id("verifyNote").classList.add("hidden");
          $id("userDisplay").textContent = "Not Logged In";
          return;
        }

        const ordersClaim = claims?.[API_AUDIENCE + "/orders"] || [];
        setStatus("ok", "Logged in. Start your order!");
        showJson("sessionBox", {
          logged_in_as: user?.email || user?.name,
          email_verified: emailVerified,
          orders_snapshot_from_id_token: ordersClaim
        });
        $id("verifyNote").classList.toggle("hidden", emailVerified);
        $id("userDisplay").textContent = user?.email || user?.name || "Not Logged In";
      }

      // ==== Auth handlers ====
      async function login() {
        setStatus("warn", "Redirecting to Universal Login…");
        await auth0Client.loginWithRedirect(); // Authorization Code + PKCE
      }
      function logout() {
        setStatus("warn", "Logging out…");
        auth0Client.logout({ logoutParams: { returnTo: window.location.origin } });
      }

      // ==== API: Place Order / List Orders ====
      async function apiCreateOrder(items) {
        const token = await auth0Client.getTokenSilently({
          authorizationParams: { audience: API_AUDIENCE, scope: "create:orders" }
        });
        const resp = await fetch(`${API_BASE}/orders`, {
          method:"POST",
          headers:{ "Authorization":`Bearer ${token}`,"Content-Type":"application/json" },
          body: JSON.stringify({
            items: items.map(i=>({ id:i.id, qty:i.qty })),
            total: Number(cartTotal().toFixed(2)),
            address: "123 Pizza St"
          })
        });
        const data = await resp.json();
        await renderSession(); // refreshes claims (post login)
        setStatus(resp.ok ? "ok" : "err", resp.ok ? "Order created ✅" : `API error (${resp.status})`);
        showJson("apiBox",{ status:resp.status, data });        
      }

      async function apiListOrders() {
        const token = await auth0Client.getTokenSilently({
          authorizationParams: { audience: API_AUDIENCE, scope: "read:orders" }
        });
        const resp = await fetch(`${API_BASE}/orders`, { headers:{ "Authorization":`Bearer ${token}` }});
        const data = await resp.json();
        setStatus(resp.ok ? "ok" : "err", resp.ok ? "Fetched orders ✅" : `API error (${resp.status})`);
        showJson("apiBox",{ status:resp.status, data });

        // prints order history
        const ul = document.getElementById("ordersList");
        ul.innerHTML = "";
        const orders = Array.isArray(data?.orders) ? data.orders : [];
        if (!orders.length) {
          ul.innerHTML = '<li class="list-group-item text-muted">No past orders yet.</li>';
        } else {
          orders.forEach(o=>{
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
              <div>
                <strong>#${o.id}</strong> — ${new Date(o.created_at).toLocaleString()}
                <div class="small text-muted">
                  ${(o.items||[]).map(i=>`${i.id} x${i.qty}`).join(", ")} ${o.address?`— ${o.address}`:""}
                </div>
              </div>
              <span class="badge badge-primary badge-pill">$${Number(o.total).toFixed(2)}</span>`;
            ul.appendChild(li);
          });
        }
      }

      // ==== Boot ====
      (async () => {
        renderCatalog();
        renderCart();

        await loadConfig();
        auth0Client = await auth0.createAuth0Client({
          domain: AUTH0_DOMAIN,
          clientId: AUTH0_CLIENT_ID,
          authorizationParams: {
            audience: API_AUDIENCE,
            scope: "openid profile email create:orders read:orders",
            redirect_uri: window.location.origin
          }
        });

        if (location.search.includes("code=") && location.search.includes("state=")) {
          await auth0Client.handleRedirectCallback();
          history.replaceState({}, document.title, "/");
        }

        await renderSession();

        $id("btnLogin").onclick = login;
        $id("btnLogout").onclick = logout;
        $id("btnList").onclick = () => requireSessionAndEmail(apiListOrders);
        $id("btnPlaceOrder").onclick = () => requireSessionAndEmail(async () => {
          if (CART.length===0) { setStatus("warn","Your cart is empty."); return; }
          await apiCreateOrder(CART);
          CART = [];
          renderCart();
        });
      })();
    </script>
  </body>
</html>
